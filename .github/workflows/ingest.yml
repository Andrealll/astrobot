name: Ingest KB to Supabase

on:
  workflow_dispatch: {}
  repository_dispatch:
    types: [kb-updated]

jobs:
  ingest:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Checkout private KB
        uses: actions/checkout@v4
        with:
          repository: Andrealll/astrobot-kb
          ref: main
          token: ${{ secrets.KB_READ_TOKEN }}
          path: kb_repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Ensure kb/ directory and copy KB files
        run: |
          rm -rf kb || true
          mkdir -p kb
          cp -a kb_repo/. kb/

      - name: Debug KB tree
        run: |
          echo "PWD=$(pwd)"
          ls -la kb || true
          find kb -type f -name "*.md" | wc -l
          find kb -type f -name "*.md" | head -n 20

      - name: Ingest into Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          KB_DIR: kb
          EMBEDDING_MODEL: intfloat/multilingual-e5-small
        run: python ingest.py
