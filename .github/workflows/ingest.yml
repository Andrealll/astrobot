name: Ingest KB to Supabase

on:
  workflow_dispatch: {}              # abilita il bottone "Run workflow"
  repository_dispatch:
    types: [kb-updated]             # opzionale: trigger dal repo KB privato

jobs:
  ingest:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Checkout private KB
        uses: actions/checkout@v4
        with:
          repository: ORG/astrobot-kb     # <-- metti il tuo org/utente
          ref: main                       # <-- cambia se il branch KB non Ã¨ main
          token: ${{ secrets.KB_READ_TOKEN }}
          path: kb

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # Debug utile: verifica che i .md ci siano
      - name: Debug KB tree
        run: |
          echo "PWD=$(pwd)"
          ls -la kb || true
          find kb -type f -name "*.md" | wc -l
          find kb -type f -name "*.md" | head -n 20

      - name: Ingest into Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          KB_DIR: kb
        run: python ingest.py
